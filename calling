#! /bin/sh

#Created by Anne-Sophie DenommÃ©-Pichon
#2015-12-06

############################ ALIGNMENT ############################
#To do.

#Get reference genome file from 1kG
test -f ~/db/human_g1k_v37.fasta || wget ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/reference/human_g1k_v37.fasta.gz -O - | gunzip > ~/db/human_g1k_v37.fasta
test -f ~/db/human_g1k_v37.fasta.fai || wget ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/reference/human_g1k_v37.fasta.fai -O ~/db/human_g1k_v37.fasta.fai
test -f ~/db/human_g1k_v37.dict || picard-tools CreateSequenceDictionary R= ~/db/human_g1k_v37.fasta O= ~/db/human_g1k_v37.dict

############################  CALLING  ############################

#Get capture files
test -f ~/db/Agilent/S04380110_Covered.bed || (echo 'ERROR - Capture .bed are missing. To get the capture .bed, download the data from https://earray.chem.agilent.com/suredesign. Just create an account, log in, and select the "Find Designs" tab, then "SureSelect DNA" then under that select "Agilent Catalog", then there should be a list of the different SureSelect related bed files and whatnot.' && exit 1)
test -f ~/db/Agilent/S04380110_Covered_noprefix.bed || grep -v '^(browser|track)' > ~/db/Agilent/S04380110_Covered_noprefix.bed

#Get dbSNP database
test -f ~/db/dbSNP/GRCh37p13_dbsnp146_00-All.vcf || wget ftp://ftp.ncbi.nlm.nih.gov/snp/organisms/human_9606_b146_GRCh37p13/VCF/00-All.vcf.gz -O - | gunzip > ~/db/dbSNP/GRCh37p13_dbsnp146_00-All.vcf

#Split the Capture .bed  file into 24 files
#For now, not used in the calling. I have to implement this.
#nb_line_bed=$(wc -l ~/db/Agilent/S04380110_Covered_noprefix.bed | awk '{print $1}')
#nb_line_split=$(((nb_line_bed+23)/24))
#for i in $(seq 24)
#	do
#		test -f ~/db/Agilent/S04380110_Covered_noprefix_$i.bed || \
#		sed -n "$((nb_line_split*(i-1))),$((nb_line_split*i-1)) p" ~/db/Agilent/S04380110_Covered_noprefix.bed > ~/db/Agilent/S04380110_Covered_noprefix_$i.bed
#	done

#Call variants with GATK HaplotypeCaller in gVCF
java -Xmx16g -jar ~/tools/GATK/GenomeAnalysisTK.jar \
	-nt 24 \
	-T HaplotypeCaller \
		-ERC GVCF \
		--variant_index_type LINEAR \
		--variant_index_parameter 128000 \
	-R ~/db/human_g1k_v37.fasta \
	-stand_call_conf 50.0 \
	-stand_emit_conf 10.0 \
	-S SILENT \
	-L:capture,BED ~/db/Agilent/S04380110_Covered_noprefix.bed \
	-I "$1" \
	--dbsnp:vcfinput,VCF ~/db/dbSNP/GRCh37p13_dbsnp146_00-All.vcf \
	-o $(echo "$1" | sed 's/.bam$/.vcf/')

